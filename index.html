<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Seyðisfjörður Community Radio</title>
  </head>
  <body>
    <div id="top-container">
      <img
        src="assets/bluehour-map.svg"
        id="bluehour"
        alt="blue hour and all the rest"
      />
      <div id="live-now-container">
        <span class="font-louise">LIVE: <br /></span>
        <span id="live-now">GATHERING...</span>
      </div>
      <button id="play-button" aria-label="Play button">
        <svg
          width="50"
          height="50"
          viewBox="0 0 50 50"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path d="M50 25L0 50L0 0L50 25Z" fill="#1E00FF" />
        </svg>
        <div class="stop-icon"></div>
      </button>
      <span id="intro">
        SEYDISFJORDUR COMMUNITY RADIO<br />
        DEC 5 - DEC 6<br />
        1600 - 1600<br />
      </span>
      <div id="schedule-link">
        <a href="#schedule-container">SCHEDULE</a>
      </div>
      <div id="time"></div>
      <div id="time-display"></div>
    </div>
    <div id="schedule-container"></div>
  </body>

  <style>
    @font-face {
      font-family: "harber";
      src: url("assets/Harber-Medium.woff2") format("woff2");
      font-weight: normal;
      font-style: normal;
    }

    @font-face {
      font-family: "louise";
      src: url("assets/Louse-Regular.woff2") format("woff2");
      font-weight: normal;
      font-style: normal;
    }

    :root {
      --primary-colour: #1e00ff;
      --background-colour: #ffffff;
    }

    html,
    body {
      background: var(--background-colour);
      color: var(--primary-colour);
      font-family: "harber", sans-serif;
    }

    .font-louise {
      font-family: "louise", serif;
      font-size: 1.5rem;
    }

    #top-container {
      min-height: 100vh;
      position: relative;
    }

    #bluehour {
      position: absolute;
      width: 90vw;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    @media (min-width: 768px) {
      #bluehour {
        width: 60vw;
      }
    }

    #live-now-container {
      position: absolute;
      top: 20px;
      left: 20px;
      max-width: 200px;
    }

    #intro {
      position: absolute;
      bottom: 20px;
      left: 20px;
      max-width: 250px;
    }

    #schedule-link {
      position: fixed;
      bottom: 20px;
      right: 20px;
      max-width: 200px;
      text-align: right;
    }

    #schedule-link a {
      text-decoration: none;
      color: inherit;
    }

    #schedule-container {
      padding: 20px 20px;
      min-height: 100vh;
    }

    .schedule-event {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--primary-colour);
    }

    .schedule-event:last-child {
      border-bottom: none;
    }

    .event-time {
      font-weight: bold;
    }

    #play-button {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #play-button.loading svg path {
      opacity: 0.5;
    }

    #play-button.playing svg {
      display: none;
    }

    #play-button .stop-icon {
      display: none;
      width: 50px;
      height: 50px;
      background-color: var(--primary-colour);
    }

    #play-button.playing .stop-icon {
      display: block;
    }

    #time {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100vw;
      height: 0%;
      z-index: 9999;
      pointer-events: none;
      transition: height 1s ease, background-color 1s ease;
    }

    #time-display {
      position: fixed;
      bottom: 20px;
      right: 20px;
      color: var(--primary-colour);
      z-index: 10000;
    }

    #time-display .colon {
      animation: blink 1s steps(1) infinite;
    }

    #time-blinker {
      animation: blink 1s steps(1) infinite;
    }

    @keyframes blink {
      0%,
      50% {
        opacity: 1;
      }
      50.01%,
      100% {
        opacity: 0;
      }
    }
  </style>

  <script>
    // Force scroll to top on page load
    if (history.scrollRestoration) {
      history.scrollRestoration = "manual";
    }
    window.scrollTo(0, 0);

    // Audio player functionality
    const playButton = document.getElementById("play-button");
    const audio = new Audio(
      "https://seyisfjorur-community-radio.radiocult.fm/stream"
    );
    let isPlaying = false;

    playButton.addEventListener("click", async () => {
      if (isPlaying) {
        audio.pause();
        playButton.classList.remove("playing");
        isPlaying = false;
      } else {
        playButton.classList.add("loading");
        try {
          await audio.play();
          playButton.classList.remove("loading");
          playButton.classList.add("playing");
          isPlaying = true;
        } catch (error) {
          console.error("Error playing audio:", error);
          playButton.classList.remove("loading");
        }
      }
    });

    // Fetch and display schedule
    async function fetchSchedule() {
      const now = new Date();
      const nextFriday = new Date(now);

      // Calculate next Friday
      const daysUntilFriday = (5 - now.getDay() + 7) % 7;
      nextFriday.setDate(
        now.getDate() + (daysUntilFriday === 0 ? 7 : daysUntilFriday)
      );
      nextFriday.setHours(16, 0, 0, 0);

      // Saturday at 16:00
      const saturday = new Date(nextFriday);
      saturday.setDate(saturday.getDate() + 1);

      const startDate = nextFriday.toISOString();
      const endDate = saturday.toISOString();

      try {
        const response = await fetch(
          `https://corsproxy.io/?${encodeURIComponent(
            `https://api.radiocult.fm/api/station/seyisfjorur-community-radio/schedule?startDate=${startDate}&endDate=${endDate}&timezone=Atlantic/Reykjavik`
          )}`
        );
        const data = await response.json();

        if (data.success && data.schedules) {
          displaySchedule(data.schedules);
        }
      } catch (error) {
        console.error("Error fetching schedule:", error);
      }
    }

    function displaySchedule(events) {
      const container = document.getElementById("schedule-container");

      events.forEach((event) => {
        const eventDiv = document.createElement("div");
        eventDiv.className = "schedule-event";

        const startTime = new Date(event.startDate).toLocaleTimeString(
          "en-US",
          {
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
          }
        );

        const endTime = new Date(event.endDate).toLocaleTimeString("en-US", {
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
        });

        eventDiv.innerHTML = `
          <div class="event-time">${startTime} - ${endTime}</div>
          <div class="event-title">${event.title}</div>
          ${
            event.description
              ? `<div class="event-description">${event.description}</div>`
              : ""
          }
        `;

        container.appendChild(eventDiv);
      });
    }

    // Fetch and display what's currently live
    async function fetchLiveNow() {
      try {
        const response = await fetch(
          `https://corsproxy.io/?${encodeURIComponent(
            `https://api.radiocult.fm/api/station/seyisfjorur-community-radio/schedule/live`
          )}`
        );
        const data = await response.json();
        console.log("Live now data:", data);

        const liveNowElement = document.getElementById("live-now");

        if (data.success && data.result) {
          if (data.result.content && data.result.content.title) {
            liveNowElement.textContent =
              data.result.content.title.toUpperCase();
          } else {
            liveNowElement.textContent = "BLUE HOUR AND ALL THE REST";
          }
        } else {
          console.error("API returned success: false or no result");
        }
      } catch (error) {
        console.error("Error fetching live now:", error);
      }
    }

    // Update time div height and color based on time
    function updateTimeDiv() {
      const now = new Date();
      const currentHour = now.getHours();
      const currentMinute = now.getMinutes();
      const currentSecond = now.getSeconds();

      // Calculate total minutes since 16:00 today or yesterday
      let minutesSince1600;
      if (currentHour >= 16) {
        // After 16:00 today
        minutesSince1600 =
          (currentHour - 16) * 60 + currentMinute + currentSecond / 60;
      } else {
        // Before 16:00 today (so counting from 16:00 yesterday)
        minutesSince1600 =
          (24 - 16 + currentHour) * 60 + currentMinute + currentSecond / 60;
      }

      // Total minutes in 24 hours = 1440
      const totalMinutes = 24 * 60;
      const percentage = (minutesSince1600 / totalMinutes) * 100;

      // Update height
      const timeDiv = document.getElementById("time");
      timeDiv.style.height = `${percentage}%`;

      // Format time as HH:MM with blinking colon
      const formattedHours = String(currentHour).padStart(2, "0");
      const formattedMinutes = String(currentMinute).padStart(2, "0");

      // Update time display element
      const timeDisplay = document.getElementById("time-display");
      timeDisplay.innerHTML = `${formattedHours}<span class="colon">:</span>${formattedMinutes}`;

      // Position time display just above the growing time bar
      timeDisplay.style.bottom = `calc(${percentage}% + 10px)`;

      // Color gradient through 24 hours - creating a color journey
      // Using HSL for smooth color transitions
      const hue = (minutesSince1600 / totalMinutes) * 360; // Full color wheel over 24h

      // Inverted colors (using mix-blend-mode for true inversion)
      timeDiv.style.backgroundColor = `hsl(${hue}, 70%, 50%)`;
      timeDiv.style.mixBlendMode = "difference";
    }

    // Load schedule and live now on page load
    fetchSchedule();
    fetchLiveNow();
    updateTimeDiv();

    // Update live now every 30 seconds
    setInterval(fetchLiveNow, 30000);

    // Update time div every second for smooth animation
    setInterval(updateTimeDiv, 1000);
  </script>
</html>
