<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Seyðisfjörður Community Radio</title>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  </head>
  <body>
    <div id="top-container">
      <img
        src="assets/bluehour-map.png"
        id="bluehour"
        alt="blue hour and all the rest"
      />
      <img
        src="assets/bluehour-map-dark.png"
        id="bluehour-dark"
        alt="blue hour dark mode"
      />
      <div id="live-now-container">
        <span class="font-louise">LIVE: <br /></span>
        <span id="live-now">GATHERING...</span>
      </div>
      <button id="play-button" aria-label="Play button">
        <svg
          width="50"
          height="50"
          viewBox="0 0 50 50"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path d="M50 25L0 50L0 0L50 25Z" fill="#1E00FF" />
        </svg>
        <div class="stop-icon"></div>
      </button>
      <span id="intro">
        SEYDISFJORDUR COMMUNITY RADIO<br />
        DEC 5 - DEC 6<br />
        1600 - 1600<br />
      </span>
      <div id="schedule-link">
        <a href="#schedule-container">SCHEDULE</a>
      </div>
      <div id="time-display"></div>
      <img src="assets/stars.png" id="stars-image" alt="Stars" />
      <div id="marquee-container">
        <div class="marquee-content">
          <span class="font-louise" id="marquee-text"
            >THE&nbsp;&nbsp;FORAY&nbsp;&nbsp;OF&nbsp;&nbsp;THE&nbsp;&nbsp;FOOL&nbsp;&nbsp;LEAVES&nbsp;&nbsp;A&nbsp;&nbsp;PATH&nbsp;&nbsp;FOR&nbsp;&nbsp;THE&nbsp;&nbsp;FOOL</span
          >
        </div>
      </div>
      <div id="time"></div>
    </div>
    <marquee id="network-marquee"
      >a network <span class="font-louise">of</span> signals, encounters
      <span class="font-louise">and</span> shared presence ✦ a network
      <span class="font-louise">of</span> signals, encounters
      <span class="font-louise">and</span> shared presence ✦ a network
      <span class="font-louise">of</span> signals, encounters
      <span class="font-louise">and</span> shared presence ✦
    </marquee>
    <div id="schedule-container"></div>
    <div id="thanks-container">
      thanks to: irene, sofie, anna, stella, ivanna, tom, olga, yr, lucie,
      silje, lili, jack, jeff, hannah, tilde, eik, jonas, evelin, rosa, mark,
      heiðdís, mari, aoife, lara, noa, amanda
    </div>
  </body>

  <style>
    @font-face {
      font-family: "harber";
      src: url("assets/Harber-Medium.woff2") format("woff2");
      font-weight: normal;
      font-style: normal;
    }

    @font-face {
      font-family: "louise";
      src: url("assets/Louise-Regular.woff2") format("woff2");
      font-weight: normal;
      font-style: normal;
    }

    :root {
      --primary-colour: #1e00ff;
      --background-colour: #ffffff;
    }

    html,
    body {
      background: var(--background-colour);
      color: var(--primary-colour);
      font-family: "harber", sans-serif;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    .font-louise {
      font-family: "louise", serif;
      font-size: 1.5rem;
    }

    #top-container {
      min-height: 100vh;
      position: relative;
    }

    #bluehour,
    #bluehour-dark {
      position: absolute;
      width: 90vw;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      cursor: pointer;
    }

    #bluehour-dark {
      display: none;
    }

    body.bluehour-active #bluehour {
      display: none;
    }

    body.bluehour-active #bluehour-dark {
      display: block;
    }

    #network-marquee {
      width: 100vw;
      padding-top: 20px;
      padding-bottom: 20px;
    }

    @media (min-width: 768px) {
      #bluehour,
      #bluehour-dark {
        width: 60vw;
      }
    }

    #live-now-container {
      position: absolute;
      top: 20px;
      left: 20px;
      max-width: 200px;
    }

    #intro {
      position: absolute;
      bottom: 20px;
      left: 20px;
      max-width: 250px;
    }

    #schedule-link {
      position: fixed;
      bottom: 20px;
      right: 20px;
      max-width: 200px;
      text-align: right;
    }

    #schedule-link a {
      text-decoration: none;
      color: inherit;
    }

    #schedule-container {
      padding: 20px 20px;
      min-height: 100vh;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 200px));
      gap: 20px;
    }

    #thanks-container {
      padding: 20px 20px;
      max-width: 65ch;
    }

    .schedule-event {
      max-width: 200px;
    }

    .event-time {
      font-weight: bold;
      margin-bottom: 4px;
      font-size: 0.7rem;
    }

    .event-title {
      margin-bottom: 8px;
    }

    .event-icon {
      width: 20px;
      height: 20px;
      object-fit: contain;
      display: inline-block;
      vertical-align: middle;
      margin-left: 2px;
      transform: rotate(12deg);
    }

    .event-description {
      font-size: 0.9em;
    }

    #play-button {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #play-button.loading svg path {
      opacity: 0.5;
    }

    #play-button.playing svg {
      display: none;
    }

    #play-button .stop-icon {
      display: none;
      width: 50px;
      height: 50px;
      background-color: var(--primary-colour);
    }

    #play-button.playing .stop-icon {
      display: block;
    }

    #time {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100vw;
      height: 0%;
      z-index: 9999;
      pointer-events: none;
      transition: height 1s ease, background-color 1s ease;
    }

    #time.testing-mode {
      transition: none;
    }

    #time-display {
      position: fixed;
      bottom: 20px;
      right: 20px;
      color: var(--primary-colour);
      z-index: 10000;
    }

    #time-display .colon {
      animation: blink 1s steps(1) infinite;
    }

    #time-blinker {
      animation: blink 1s steps(1) infinite;
    }

    @keyframes blink {
      0%,
      50% {
        opacity: 1;
      }
      50.01%,
      100% {
        opacity: 0;
      }
    }

    /* Blue Hour Mode Styles */
    body.bluehour-active {
      background-color: #000000;
    }

    #stars-image {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 40vw;
      max-height: 40vh;
      object-fit: contain;
      mix-blend-mode: screen;
      z-index: 9998;
      display: none;
      pointer-events: none;
      opacity: 1;
      filter: invert();
    }

    body.bluehour-active #stars-image {
      display: block;
      /* animation: flashPattern 4s steps(1) infinite; */
    }

    @keyframes flashPattern {
      0%,
      14% {
        opacity: 1;
      }
      /* on */
      14%,
      28% {
        opacity: 0;
      }
      /* off */
      28%,
      42% {
        opacity: 1;
      }
      /* on */
      42%,
      56% {
        opacity: 0;
      }
      /* off */
      56%,
      60% {
        opacity: 1;
      }
      /* on (quick) */
      60%,
      64% {
        opacity: 0;
      }
      /* off (quick) */
      64%,
      68% {
        opacity: 1;
      }
      /* on (quick) */
      68%,
      72% {
        opacity: 0;
      }
      /* off (quick) */
      72%,
      76% {
        opacity: 1;
      }
      /* on (quick) */
      76%,
      100% {
        opacity: 0;
      }
      /* off */
    }

    #marquee-container {
      position: absolute;
      top: 50%;
      left: 0;
      transform: translateY(-50%);
      width: 100vw;
      overflow: hidden;
      z-index: 9999;
      display: none;
      pointer-events: none;
    }

    body.bluehour-active #marquee-container {
      display: block;
    }

    .marquee-content {
      display: inline-block;
      animation: marquee 20s linear infinite;
      white-space: nowrap;
    }

    #marquee-container .font-louise {
      font-size: 3rem;
      color: var(--primary-colour);
      white-space: nowrap;
      display: inline-block;
      padding-right: 100vw;
    }

    @keyframes marquee {
      0% {
        transform: translateX(100vw);
      }
      100% {
        transform: translateX(-100%);
      }
    }

    @media (max-width: 768px) {
      #marquee-container .font-louise {
        font-size: 2rem;
      }

      #stars-image {
        max-width: 70vw;
      }
    }

    #bluehour {
      cursor: pointer;
    }
  </style>

  <script>
    // Force scroll to top on page load
    if (history.scrollRestoration) {
      history.scrollRestoration = "manual";
    }
    window.scrollTo(0, 0);

    // Audio player functionality
    const playButton = document.getElementById("play-button");
    const audio = new Audio(
      "https://seyisfjorur-community-radio.radiocult.fm/stream"
    );
    let isPlaying = false;

    playButton.addEventListener("click", async () => {
      if (isPlaying) {
        audio.pause();
        playButton.classList.remove("playing");
        isPlaying = false;
      } else {
        playButton.classList.add("loading");
        try {
          await audio.play();
          playButton.classList.remove("loading");
          playButton.classList.add("playing");
          isPlaying = true;
        } catch (error) {
          console.error("Error playing audio:", error);
          playButton.classList.remove("loading");
        }
      }
    });

    // Fetch and display schedule
    async function fetchSchedule() {
      const DateTime = luxon.DateTime;
      const now = DateTime.now().setZone("Atlantic/Reykjavik");

      // Calculate next Friday at 16:00
      const daysUntilFriday = (5 - now.weekday + 7) % 7;
      const nextFriday = now
        .plus({ days: daysUntilFriday === 0 ? 7 : daysUntilFriday })
        .set({ hour: 16, minute: 0, second: 0, millisecond: 0 });

      // Saturday at 16:00
      const saturday = nextFriday.plus({ days: 1 });

      const startDate = nextFriday.toUTC().toISO();
      const endDate = saturday.toUTC().toISO();

      try {
        const response = await fetch(
          `https://corsproxy.io/?${encodeURIComponent(
            `https://api.radiocult.fm/api/station/seyisfjorur-community-radio/schedule?startDate=${startDate}&endDate=${endDate}&timezone=Atlantic/Reykjavik`
          )}`
        );
        const data = await response.json();
        console.log("Schedule data:", data);

        if (data.success && data.schedules) {
          console.log("Number of events:", data.schedules.length);
          displaySchedule(data.schedules);
        } else {
          console.log("No schedules found or API returned success: false");
        }
      } catch (error) {
        console.error("Error fetching schedule:", error);
      }
    }

    function displaySchedule(events) {
      const container = document.getElementById("schedule-container");
      const DateTime = luxon.DateTime;
      console.log("displaySchedule called with events:", events);

      events.forEach((event, index) => {
        const eventDiv = document.createElement("div");
        eventDiv.className = "schedule-event";

        console.log(`Processing event ${index}:`, event);

        // Parse dates with Luxon - use 'start' and 'end' fields
        let startDate = DateTime.fromISO(event.start);
        let endDate = DateTime.fromISO(event.end);

        // Check if dates are valid
        if (!startDate.isValid || !endDate.isValid) {
          console.error("Invalid date for event:", event, {
            startDate: startDate.invalidReason,
            endDate: endDate.invalidReason,
          });
          return;
        }

        const startTime = startDate.toFormat("HH:mm");
        const endTime = endDate.toFormat("HH:mm");

        // Extract key from curly brackets in title (e.g., "church bells rings (church)" -> "church")
        // The image key is what's inside the parentheses within the curly brackets
        const bracketMatch = event.title.match(/\(([^\)]+)\)/);
        const imageKey = bracketMatch ? bracketMatch[1] : null;

        // Remove parentheses and their content from title
        const titleWithoutBrackets = event.title
          .replace(/\s*\([^\)]+\)\s*/g, "")
          .trim();

        eventDiv.innerHTML = `
          <div class="event-time">
            ${startTime} - ${endTime}
            ${
              imageKey
                ? `<img src="assets/symbols/${imageKey}.png" alt="${imageKey}" class="event-icon">`
                : ""
            }
          </div>
          <div class="event-title">
            ${titleWithoutBrackets}
          </div>
          ${
            event.description
              ? `<div class="event-description">${event.description}</div>`
              : ""
          }
        `;

        container.appendChild(eventDiv);
      });
    }

    // Fetch and display what's currently live
    async function fetchLiveNow() {
      try {
        const response = await fetch(
          `https://corsproxy.io/?${encodeURIComponent(
            `https://api.radiocult.fm/api/station/seyisfjorur-community-radio/schedule/live`
          )}`
        );
        const data = await response.json();

        const liveNowElement = document.getElementById("live-now");

        if (data.success && data.result) {
          if (data.result.content && data.result.content.title) {
            liveNowElement.textContent =
              data.result.content.title.toUpperCase();
          } else {
            liveNowElement.textContent = "BLUE HOUR AND ALL THE REST";
          }
        } else {
          console.error("API returned success: false or no result");
        }
      } catch (error) {
        console.error("Error fetching live now:", error);
      }
    }

    // Testing mode: 24 hours cycle in 30 seconds
    const TESTING_MODE = true;
    const CYCLE_DURATION_MS = 30000; // 30 seconds
    let startTime = null;

    // Update time div height and color based on time
    function updateTimeDiv() {
      let currentHour, currentMinute, currentSecond, minutesSince1600;

      if (TESTING_MODE) {
        // Initialize startTime on first call
        if (startTime === null) {
          startTime = Date.now();
        }

        // Calculate simulated time - 24 hours in 30 seconds
        const elapsed = Date.now() - startTime;
        const cycleProgress = (elapsed % CYCLE_DURATION_MS) / CYCLE_DURATION_MS;

        // Direct calculation: total minutes in 24 hours = 1440
        minutesSince1600 = cycleProgress * (24 * 60);

        // Calculate display time starting from 16:00
        const totalSeconds = minutesSince1600 * 60;
        currentHour = Math.floor(totalSeconds / 3600) + 16;
        currentMinute = Math.floor((totalSeconds % 3600) / 60);
        currentSecond = Math.floor(totalSeconds % 60);

        // Wrap hours to 24-hour format
        if (currentHour >= 24) {
          currentHour = currentHour - 24;
        }
      } else {
        // Real-time mode
        const now = new Date();
        currentHour = now.getHours();
        currentMinute = now.getMinutes();
        currentSecond = now.getSeconds();

        // Calculate total minutes since 16:00 today or yesterday
        if (currentHour >= 16) {
          // After 16:00 today
          minutesSince1600 =
            (currentHour - 16) * 60 + currentMinute + currentSecond / 60;
        } else {
          // Before 16:00 today (so counting from 16:00 yesterday)
          minutesSince1600 =
            (24 - 16 + currentHour) * 60 + currentMinute + currentSecond / 60;
        }
      }

      // Total minutes in 24 hours = 1440
      const totalMinutes = 24 * 60;
      const percentage = (minutesSince1600 / totalMinutes) * 100;

      // Update height
      const timeDiv = document.getElementById("time");
      if (TESTING_MODE) {
        timeDiv.classList.add("testing-mode");
      }
      timeDiv.style.height = `${percentage}%`;

      // Format time as HH:MM with blinking colon
      const formattedHours = String(currentHour).padStart(2, "0");
      const formattedMinutes = String(currentMinute).padStart(2, "0");

      // Update time display element
      const timeDisplay = document.getElementById("time-display");
      timeDisplay.innerHTML = `${formattedHours}<span class="colon">:</span>${formattedMinutes}`;

      // Position time display just above the growing time bar
      timeDisplay.style.bottom = `calc(${percentage}% + 10px)`;

      // Color gradient through 24 hours - creating a color journey
      // Using HSL for smooth color transitions
      const hue = (minutesSince1600 / totalMinutes) * 360; // Full color wheel over 24h

      // Inverted colors (using mix-blend-mode for true inversion)
      timeDiv.style.backgroundColor = `hsl(${hue}, 70%, 50%)`;
      timeDiv.style.mixBlendMode = "difference";
    }

    // Blue Hour Mode Toggle
    const bluehourImage = document.getElementById("bluehour");
    const bluehourDarkImage = document.getElementById("bluehour-dark");
    let bluehourActive = false;

    function toggleBluehourMode() {
      bluehourActive = !bluehourActive;

      if (bluehourActive) {
        // Get current live text and update marquee
        const liveNowText = document.getElementById("live-now").textContent;

        // Activate blue hour mode
        document.body.classList.add("bluehour-active");
      } else {
        // Deactivate blue hour mode
        document.body.classList.remove("bluehour-active");
      }
    }

    bluehourImage.addEventListener("click", toggleBluehourMode);
    bluehourDarkImage.addEventListener("click", toggleBluehourMode);

    // Update marquee text when live now changes
    const originalFetchLiveNow = fetchLiveNow;
    fetchLiveNow = async function () {
      await originalFetchLiveNow();
      if (bluehourActive) {
        const liveNowText = document.getElementById("live-now").textContent;
        marqueeText.textContent = liveNowText;
      }
    };

    // Load schedule and live now on page load
    fetchSchedule();
    fetchLiveNow();
    updateTimeDiv();

    // Update live now every 30 seconds
    setInterval(fetchLiveNow, 30000);

    // Update time div every second for smooth animation
    setInterval(updateTimeDiv, 10);
  </script>
</html>
